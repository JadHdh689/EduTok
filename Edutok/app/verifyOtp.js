import { useState } from 'react';
import { View, Text, TextInput, TouchableOpacity, Alert } from 'react-native';
import { useLocalSearchParams, useRouter } from 'expo-router';

export default function VerifyOtp() {
  const { email } = useLocalSearchParams();
  const router = useRouter();
  const [otp, setOtp] = useState('');
  const [loading, setLoading] = useState(false);

  const handleVerify = async () => {
    if (!otp) {
      Alert.alert('Error', 'Please enter the code');
      return;
    }
    try {
      setLoading(true);
      const res = await fetch(
        `${process.env.EXPO_PUBLIC_API_URL}/api/auth/verify-otp`,
        {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, otp })
        }
      );
      const data = await res.json();
      setLoading(false);

      if (!res.ok) {
        Alert.alert('Error', data.error || 'Verification failed');
        return;
      }

      Alert.alert('Success', 'Account verified. Please sign in.');
      router.replace('/login');

    } catch (e) {
      setLoading(false);
      Alert.alert('Error', 'Network error. Try again.');
    }
  };

  return (
    <View style={{ flex: 1, padding: 24, justifyContent: 'center' }}>
      <Text style={{ fontSize: 18, marginBottom: 12 }}>
        Enter the 6-digit code sent to {email}
      </Text>
      <TextInput
        placeholder="123456"
        keyboardType="number-pad"
        value={otp}
        onChangeText={setOtp}
        style={{ borderWidth: 1, borderRadius: 10, padding: 12 }}
      />
      <TouchableOpacity
        onPress={handleVerify}
        disabled={loading}
        style={{ marginTop: 16, padding: 14, borderRadius: 10, backgroundColor: 'black' }}
      >
        <Text style={{ color: 'white', textAlign: 'center' }}>
          {loading ? 'Verifyingâ€¦' : 'Verify'}
        </Text>
      </TouchableOpacity>
    </View>
  );
}
